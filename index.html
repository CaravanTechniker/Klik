<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>CaravanTechniker am Main</title>
  <style>
    :root{
      --bg1:#9ec7e6;     /* tmavšie modré pozadie */
      --bg2:#cfe7f8;     /* bledomodré karty */
      --card:#d9ecfb;
      --ink:#0b1b2a;
      --muted:#4b647a;
      --btn:#ffffff;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
      --radius: 22px;
    }

    /* cca -10% celá app */
    html, body { height:100%; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 90%;
      color:var(--ink);
      background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 45%, #e9f5ff 100%);
    }

    .wrap{ max-width: 980px; margin: 0 auto; padding: 18px 14px 34px; }
    .top{
      display:flex; align-items:flex-start; justify-content:space-between; gap:14px;
      padding: 6px 2px 14px;
    }
    .brand{ flex:1; min-width: 260px; }
    /* CaravanTechniker am Main menšie */
    .brand h1{
      margin:0;
      font-size: 2.35rem; /* menšie než predtým */
      letter-spacing:.2px;
      line-height:1.05;
      font-weight: 900;
      text-shadow: 0 1px 0 rgba(255,255,255,.35);
    }
    /* Wohnmobil Diagnose väčšie */
    .brand .sub{
      margin-top:6px;
      font-size: 1.35rem; /* väčšie */
      font-weight: 700;
      color: var(--muted);
    }

    .actions{
      display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;
    }
    .pill{
      border:0;
      background: rgba(255,255,255,.85);
      padding: 12px 16px;
      border-radius: 999px;
      font-weight: 800;
      letter-spacing:.2px;
      box-shadow: 0 4px 16px rgba(0,0,0,.12);
      cursor:pointer;
    }
    .pill:active{ transform: translateY(1px); }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 16px;
    }

    .card{
      background: rgba(217,236,251,.85);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(6px);
    }
    .card h2{
      margin:0 0 10px;
      font-size: 2.2rem;
      font-weight: 900;
    }
    .hint{ color: var(--muted); font-weight: 650; margin: 0 0 12px; }
    .search{
      width:100%;
      padding: 14px 16px;
      border-radius: 999px;
      border: 2px solid rgba(11,27,42,.10);
      background: rgba(255,255,255,.75);
      outline:none;
      font-size: 1.05rem;
      font-weight: 650;
    }

    .list{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 12px;
    }
    .item{
      border-radius: 18px;
      padding: 14px 14px;
      background: rgba(255,255,255,.35);
      border: 2px solid rgba(11,27,42,.08);
      cursor:pointer;
    }
    .item:active{ transform: translateY(1px); }
    .item .t{
      font-size: 1.25rem;
      font-weight: 900;
      margin:0 0 4px;
    }
    .item .s{
      margin:0;
      color: var(--muted);
      font-weight: 650;
      font-size: 1.02rem;
    }
    .ver{ margin-top: 10px; color: var(--muted); font-weight: 800; }

    .q{
      margin-top: 4px;
      font-size: 1.85rem;
      font-weight: 950;
      line-height: 1.08;
    }

    .btnRow{
      display:flex;
      gap: 12px;
      margin-top: 12px;
      flex-wrap:wrap;
    }
    .bigBtn{
      flex: 1 1 160px;
      border:0;
      border-radius: 20px;
      padding: 16px 18px;
      font-size: 1.6rem;
      font-weight: 950;
      cursor:pointer;
      box-shadow: 0 10px 24px rgba(0,0,0,.15);
      color:#fff;
      text-transform: uppercase;
      letter-spacing: .4px;
    }
    .yes{ background:#167a35; }
    .no{ background:#b11111; }
    .back{
      background:#f1c40f;
      color:#1b1b1b;
      flex: 1 1 100%;
    }

    .proto{
      margin-top: 14px;
    }
    .proto h3{
      margin: 0 0 8px;
      font-size: 1.5rem;
      font-weight: 950;
    }
    /* biela plocha pod písmom -> bledomodrá */
    textarea{
      width:100%;
      min-height: 190px;
      resize: vertical;
      border-radius: 16px;
      padding: 14px;
      border: 2px solid rgba(11,27,42,.12);
      background: rgba(207,231,248,.95);
      font-size: 1.05rem;
      font-weight: 650;
      color: var(--ink);
      outline:none;
    }

    .smallRow{
      display:flex; gap: 10px; margin-top: 10px; flex-wrap:wrap;
    }
    .smallBtn{
      border:0;
      padding: 12px 14px;
      border-radius: 999px;
      background: rgba(255,255,255,.85);
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,.12);
    }

    @media (max-width: 520px){
      .brand h1{ font-size: 2.15rem; }
      .brand .sub{ font-size: 1.25rem; }
      .card h2{ font-size: 2.0rem; }
      .q{ font-size: 1.6rem; }
      .bigBtn{ font-size: 1.45rem; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1 id="appTitle">CaravanTechniker am Main</h1>
        <div class="sub" id="appSub">Wohnmobil Diagnose</div>
      </div>
      <div class="actions">
        <button class="pill" id="langDE">DE</button>
        <button class="pill" id="langSK">SK</button>
        <button class="pill" id="adminBtn">ADMIN</button>
        <button class="pill" id="resetBtn">RESET</button>
      </div>
    </div>

    <div class="grid">

      <section class="card">
        <h2 id="faultsTitle">Störungen</h2>
        <p class="hint" id="faultsHint">Wähle eine Störung oder suche. Funktioniert auch offline.</p>
        <input class="search" id="search" placeholder="Suche (trittstufe, wasserpumpe, 12V...)" />
        <div class="list" id="list"></div>
        <div class="ver" id="ver"></div>
      </section>

      <section class="card">
        <h2 id="diagTitle">Diagnose</h2>
        <p class="hint" id="diagHint">Wähle links eine Störung. Dann JA / NEIN klicken.</p>
        <div class="q" id="question">Wähle links eine Störung.</div>

        <div class="btnRow">
          <button class="bigBtn yes" id="yesBtn">JA</button>
          <button class="bigBtn no" id="noBtn">NEIN</button>
          <button class="bigBtn back" id="backBtn">← SCHRITT ZURÜCK</button>
        </div>

        <div class="proto">
          <h3 id="protoTitle">Protokoll</h3>
          <textarea id="proto" readonly></textarea>
          <div class="smallRow">
            <button class="smallBtn" id="copyBtn">Kopieren</button>
            <button class="smallBtn" id="clearPathBtn">Pfad löschen</button>
            <button class="smallBtn" id="pdfBtn">PDF Download</button>
          </div>
        </div>
      </section>

    </div>
  </div>

<script>
(() => {
  const LS_LANG = "lang";
  const LS_OVERRIDE = "content_override";

  let LANG = localStorage.getItem(LS_LANG) || "de";
  let TREES = [];
  let currentTree = null;
  let currentNodeId = null;
  let path = [];

  const el = {
    appSub: document.getElementById("appSub"),
    faultsTitle: document.getElementById("faultsTitle"),
    faultsHint: document.getElementById("faultsHint"),
    diagTitle: document.getElementById("diagTitle"),
    diagHint: document.getElementById("diagHint"),
    search: document.getElementById("search"),
    list: document.getElementById("list"),
    ver: document.getElementById("ver"),
    question: document.getElementById("question"),
    proto: document.getElementById("proto"),
    yesBtn: document.getElementById("yesBtn"),
    noBtn: document.getElementById("noBtn"),
    backBtn: document.getElementById("backBtn"),
    copyBtn: document.getElementById("copyBtn"),
    clearPathBtn: document.getElementById("clearPathBtn"),
    pdfBtn: document.getElementById("pdfBtn"),
    langDE: document.getElementById("langDE"),
    langSK: document.getElementById("langSK"),
    resetBtn: document.getElementById("resetBtn"),
    adminBtn: document.getElementById("adminBtn"),
  };

  const I18N = {
    de: {
      sub: "Wohnmobil Diagnose",
      faultsTitle: "Störungen",
      faultsHint: "Wähle eine Störung oder suche. Funktioniert auch offline.",
      searchPh: "Suche (trittstufe, wasserpumpe, 12V...)",
      diagTitle: "Diagnose",
      diagHint: "Wähle links eine Störung. Dann JA / NEIN klicken.",
      pickLeft: "Wähle links eine Störung.",
      yes: "JA",
      no: "NEIN",
      back: "← SCHRITT ZURÜCK",
      protoTitle: "Protokoll",
      copy: "Kopieren",
      clear: "Pfad löschen",
      pdf: "PDF Download",
      copied: "Kopiert",
      adminPrompt: "ADMIN\n1 = Import content.json\n2 = Export content.json",
      importOk: "Import OK",
      importErr: "Import ERROR: JSON invalid",
      resetOk: "Reset OK",
      pdfTitle: "CaravanTechniker am Main – Protokoll"
    },
    sk: {
      sub: "Diagnostika obytných vozidiel",
      faultsTitle: "Poruchy",
      faultsHint: "Vyber poruchu alebo hľadaj. Funguje aj offline.",
      searchPh: "Hľadať (trittstufe, wasserpumpe, 12V...)",
      diagTitle: "Diagnostika",
      diagHint: "Vyber poruchu vľavo. Potom klikaj ÁNO / NIE.",
      pickLeft: "Vyber poruchu vľavo.",
      yes: "ÁNO",
      no: "NIE",
      back: "← SPÄŤ",
      protoTitle: "Protokol",
      copy: "Kopírovať",
      clear: "Vymazať cestu",
      pdf: "PDF Download",
      copied: "Skopírované",
      adminPrompt: "ADMIN\n1 = Import content.json\n2 = Export content.json",
      importOk: "Import OK",
      importErr: "Import ERROR: neplatný JSON",
      resetOk: "Reset OK",
      pdfTitle: "CaravanTechniker am Main – Protokol"
    }
  };

  const T = (k) => (I18N[LANG] && I18N[LANG][k]) ? I18N[LANG][k] : (I18N.de[k] || k);

  function applyLangUI(){
    document.documentElement.lang = LANG;
    el.appSub.textContent = T("sub");
    el.faultsTitle.textContent = T("faultsTitle");
    el.faultsHint.textContent = T("faultsHint");
    el.search.placeholder = T("searchPh");
    el.diagTitle.textContent = T("diagTitle");
    el.diagHint.textContent = T("diagHint");

    el.yesBtn.textContent = T("yes");
    el.noBtn.textContent = T("no");
    el.backBtn.textContent = T("back");

    document.getElementById("protoTitle").textContent = T("protoTitle");
    el.copyBtn.textContent = T("copy");
    el.clearPathBtn.textContent = T("clear");
    el.pdfBtn.textContent = T("pdf");

    if(!currentTree){
      el.question.textContent = T("pickLeft");
    } else {
      renderNode();
    }
    renderList();
    renderProto();
  }

  async function loadContent(){
    // 1) override z ADMIN importu
    const ov = localStorage.getItem(LS_OVERRIDE);
    if(ov){
      try { TREES = JSON.parse(ov); }
      catch { TREES = []; }
      return;
    }

    // 2) default content.json zo servera
    const res = await fetch("./content.json", {cache:"no-store"});
    const data = await res.json();
    TREES = Array.isArray(data) ? data : (data.trees || []);
  }

  function cleanTitleText(s){
    // odstráni prefix typu "01 " alebo "01 01 " na začiatku title, aby sa to neduplikovalo
    if(!s) return "";
    return String(s).replace(/^\s*(\d{1,3}\s+)+/,"").trim();
  }

  function treeDisplayTitle(tree){
    // Chceš LEN 1x "01" – zoberieme iba prvý segment z id (01_01 -> 01)
    const id = tree.id || "";
    const prefix = id.split("_")[0] || "";
    const raw = (tree.title && tree.title[LANG]) ? tree.title[LANG] : ((tree.title && tree.title.de) ? tree.title.de : "");
    const base = cleanTitleText(raw);
    return prefix ? `${prefix} ${base}` : base;
  }

  function treeDisplaySubtitle(tree){
    const s = tree.subtitle?.[LANG] ?? tree.subtitle?.de ?? "";
    return s || "";
  }

  function renderList(){
    const q = (el.search.value || "").trim().toLowerCase();
    el.list.innerHTML = "";
    const trees = (TREES || []).slice();

    const filtered = trees.filter(t => {
      const title = treeDisplayTitle(t).toLowerCase();
      const sub = treeDisplaySubtitle(t).toLowerCase();
      const tags = (t.tags || []).join(" ").toLowerCase();
      return !q || title.includes(q) || sub.includes(q) || tags.includes(q);
    });

    filtered.forEach(tree => {
      const div = document.createElement("div");
      div.className = "item";
      const t = document.createElement("p");
      t.className = "t";
      t.textContent = treeDisplayTitle(tree);
      const s = document.createElement("p");
      s.className = "s";
      s.textContent = treeDisplaySubtitle(tree);
      div.appendChild(t);
      div.appendChild(s);
      div.onclick = () => {
        currentTree = tree;
        currentNodeId = tree.start || tree.root || null;
        path = [];
        renderNode();
        renderProto();
      };
      el.list.appendChild(div);
    });

    // verzia
    const ver = (TREES && TREES.version) ? TREES.version : (TREES && TREES[0] && TREES[0].version ? TREES[0].version : "");
    // ak je content ako array, verzia môže byť v prvom objekte alebo mimo – necháme len ak existuje
    el.ver.textContent = (window.APP_VERSION ? `v${window.APP_VERSION}` : (ver ? `v${ver}` : "v0.1.5"));
  }

  function currentNode(){
    if(!currentTree || !currentNodeId) return null;
    return currentTree.nodes?.[currentNodeId] || null;
  }

  function nodeText(node){
    if(!node) return "";
    if(node.text && typeof node.text === "object"){
      return node.text[LANG] ?? node.text.de ?? "";
    }
    if(typeof node.text === "string") return node.text;
    return "";
  }

  function renderNode(){
    const node = currentNode();
    if(!currentTree || !node){
      el.question.textContent = T("pickLeft");
      return;
    }

    if(node.type === "question"){
      el.question.textContent = nodeText(node) || "";
    } else if(node.type === "result"){
      const cause = node.cause?.[LANG] ?? node.cause?.de ?? "";
      const action = node.action?.[LANG] ?? node.action?.de ?? "";
      el.question.textContent = (cause ? `Výsledok: ${cause}` : "Výsledok") + (action ? `\nAkcia: ${action}` : "");
    } else {
      el.question.textContent = nodeText(node) || "";
    }
  }

  function answer(val){
    const node = currentNode();
    if(!node || node.type !== "question") return;
    path.push({ nodeId: currentNodeId, answer: val });
    const next = (val === "yes") ? node.yes : node.no;
    currentNodeId = next || null;
    renderNode();
    renderProto();
  }

  function back(){
    if(path.length === 0) return;
    const last = path.pop();
    currentNodeId = last.nodeId;
    renderNode();
    renderProto();
  }

  function renderProto(){
    if(!currentTree){
      el.proto.value = "";
      return;
    }

    const now = new Date();
    const dt = now.toLocaleString(LANG === "sk" ? "sk-SK" : "de-DE");
    const title = treeDisplayTitle(currentTree);
    const tags = (currentTree.tags || []).join(", ");

    let out = "";
    out += `Zeit: ${dt}\n`;
    out += `Sprache: ${LANG.toUpperCase()}\n`;
    out += `${LANG === "sk" ? "Porucha" : "Störung"}: ${title}\n`;
    if(tags) out += `Tags: ${tags}\n\n`;

    out += `${LANG === "sk" ? "Kroky" : "Schritte"}:\n`;

    path.forEach((p, idx) => {
      const n = currentTree.nodes?.[p.nodeId];
      const q = nodeText(n);
      const aTxt = (p.answer === "yes") ? T("yes") : T("no");
      out += `${idx+1}. ${q} [${aTxt}]\n`;
    });

    const node = currentNode();
    if(node && node.type === "result"){
      const cause = node.cause?.[LANG] ?? node.cause?.de ?? "";
      const action = node.action?.[LANG] ?? node.action?.de ?? "";
      out += `\n${LANG === "sk" ? "Výsledok" : "Ergebnis"}:\n`;
      if(cause) out += `${cause}\n`;
      if(action) out += `${action}\n`;
    }

    el.proto.value = out.trim();
  }

  function hardReset(){
    currentTree = null;
    currentNodeId = null;
    path = [];
    el.search.value = "";
    renderList();
    renderNode();
    renderProto();
  }

  async function admin(){
    const choice = prompt(T("adminPrompt"));
    if(!choice) return;
    const c = choice.trim();

    if(c === "1"){
      const inp = document.createElement("input");
      inp.type = "file";
      inp.accept = "application/json,.json";
      inp.onchange = async () => {
        const f = inp.files && inp.files[0];
        if(!f) return;
        const txt = await f.text();
        try{
          const data = JSON.parse(txt);
          const arr = Array.isArray(data) ? data : (data.trees || []);
          localStorage.setItem(LS_OVERRIDE, JSON.stringify(arr));
          TREES = arr;
          hardReset();
          applyLangUI();
          alert(T("importOk"));
        }catch(e){
          alert(T("importErr"));
        }
      };
      inp.click();
    }

    if(c === "2"){
      const data = JSON.stringify(TREES, null, 2);
      const blob = new Blob([data], {type:"application/json;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `content_export_${Date.now()}.json`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    }
  }

  function downloadPdf(){
    const txt = el.proto.value || "";
    const safe = txt.replace(/[&<>]/g, (m)=>({ "&":"&amp;", "<":"&lt;", ">":"&gt;" }[m]));
    const html = `
      <!doctype html><html><head><meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <title>${T("pdfTitle")}</title>
      <style>
        body{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; padding: 20px;}
        pre{white-space: pre-wrap; font-size: 14px; line-height: 1.35;}
      </style>
      </head><body>
      <pre>${safe}</pre>
      <script>window.onload=()=>{ window.print(); }<\/script>
      </body></html>
    `;
    const w = window.open("", "_blank");
    if(!w) return;
    w.document.open();
    w.document.write(html);
    w.document.close();
  }

  // handlers
  el.langDE.onclick = () => { LANG="de"; localStorage.setItem(LS_LANG, LANG); applyLangUI(); };
  el.langSK.onclick = () => { LANG="sk"; localStorage.setItem(LS_LANG, LANG); applyLangUI(); };
  el.resetBtn.onclick = () => { hardReset(); alert(T("resetOk")); };
  el.search.oninput = () => renderList();
  el.yesBtn.onclick = () => answer("yes");
  el.noBtn.onclick = () => answer("no");
  el.backBtn.onclick = () => back();
  el.copyBtn.onclick = async () => {
    try{
      await navigator.clipboard.writeText(el.proto.value || "");
      const old = el.copyBtn.textContent;
      el.copyBtn.textContent = T("copied");
      setTimeout(()=>el.copyBtn.textContent = old, 900);
    }catch{}
  };
  el.clearPathBtn.onclick = () => { path = []; if(currentTree) currentNodeId = currentTree.start || currentTree.root || null; renderNode(); renderProto(); };
  el.pdfBtn.onclick = () => downloadPdf();
  el.adminBtn.onclick = () => admin();

  // boot
  (async () => {
    await loadContent();
    hardReset();
    applyLangUI();
  })();
})();
</script>
</body>
</html>
