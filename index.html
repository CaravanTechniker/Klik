<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>CaravanTechniker am Main</title>
  <style>
    :root{
      --bg:#bcd9ef;
      --bg2:#a9cfea;
      --card:#d8ecfb;
      --card2:#cfe6fa;
      --text:#0b1b2a;
      --muted:#506070;
      --border: rgba(0,0,0,.15);
      --shadow: 0 10px 25px rgba(0,0,0,.12);
      --btnRadius: 22px;
    }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background: linear-gradient(180deg,var(--bg2),var(--bg));
    }
    .wrap{ max-width: 980px; margin: 0 auto; padding: 18px 14px 40px; }
    .header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
      margin-bottom:12px;
    }
    .brand h1{
      margin:0; font-size: 44px; font-weight: 900; letter-spacing: -0.5px;
    }
    .brand .sub{
      margin-top:2px; font-size: 18px; color:var(--muted); font-weight: 700;
    }
    .topBtns{ display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; }
    .chipBtn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.7);
      padding: 14px 18px;
      border-radius: 999px;
      font-weight: 900;
      box-shadow: var(--shadow);
      cursor:pointer;
      user-select:none;
    }
    .chipBtn:active{ transform: translateY(1px); }
    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    .card{
      background: linear-gradient(180deg, var(--card), var(--card2));
      border:1px solid var(--border);
      border-radius: 26px;
      box-shadow: var(--shadow);
      padding: 16px;
    }
    .card h2{
      margin: 2px 0 10px; font-size: 40px; letter-spacing:-0.3px;
    }
    .row{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    .search{
      width:100%;
      padding: 16px 18px;
      border-radius: 20px;
      border:1px solid var(--border);
      font-size: 18px;
      background: rgba(255,255,255,.75);
      outline:none;
    }
    .list{
      margin-top: 10px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .item{
      padding: 14px 14px;
      border-radius: 20px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.55);
      cursor:pointer;
    }
    .item b{ font-size: 20px; display:block; margin-bottom: 2px; }
    .item span{ color: var(--muted); font-weight: 700; }
    .btnBig{
      width:100%;
      padding: 18px 18px;
      border-radius: var(--btnRadius);
      border: 1px solid var(--border);
      font-size: 30px;
      font-weight: 1000;
      cursor:pointer;
      box-shadow: var(--shadow);
      user-select:none;
    }
    .btnYes{ background:#177a37; color:#fff; }
    .btnNo{ background:#b01212; color:#fff; }
    .btnBack{ background:#f2c400; color:#111; }
    .question{
      font-size: 30px;
      font-weight: 1000;
      margin: 10px 0 12px;
    }
    .resultTitle{
      font-size: 32px;
      font-weight: 1000;
      margin: 8px 0 4px;
    }
    .resultText{ font-size: 22px; font-weight: 800; color: var(--text); }
    .protoWrap{
      background: rgba(255,255,255,.35);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 10px;
      margin-top: 10px;
    }
    textarea{
      width:100%;
      min-height: 210px;
      resize: vertical;
      border-radius: 16px;
      border: 1px solid var(--border);
      padding: 10px 12px;
      font-size: 18px;
      background: rgba(255,255,255,.75);
      outline:none;
    }
    .smallBtns{ display:flex; gap: 10px; flex-wrap:wrap; margin-top: 10px; }
    .smallBtn{
      padding: 14px 16px;
      border-radius: 18px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.75);
      font-weight: 900;
      cursor:pointer;
      box-shadow: var(--shadow);
    }
    .footerInfo{
      margin-top: 8px;
      font-weight: 800;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <h1>CaravanTechniker am Main</h1>
        <div class="sub" id="subtitleLine"></div>
      </div>
      <div class="topBtns">
        <button class="chipBtn" id="btnDE">DE</button>
        <button class="chipBtn" id="btnSK">SK</button>
        <button class="chipBtn" id="btnAdmin">ADMIN</button>
        <button class="chipBtn" id="btnReset">RESET</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2 id="hFaults"></h2>
        <input class="search" id="search" placeholder="" />
        <div class="list" id="faultList"></div>
        <div class="footerInfo" id="ver"></div>
      </div>

      <div class="card">
        <h2 id="hDiag"></h2>

        <div id="diagBox">
          <div class="question" id="qText"></div>

          <div class="row" style="gap:12px">
            <button class="btnBig btnYes" id="btnYes"></button>
            <button class="btnBig btnNo" id="btnNo"></button>
          </div>

          <div style="margin-top:12px">
            <button class="btnBig btnBack" id="btnBack"></button>
          </div>

          <div style="margin-top:12px">
            <div class="resultTitle" id="resTitle"></div>
            <div class="resultText" id="resText"></div>
          </div>

          <div class="protoWrap">
            <div style="font-size:22px;font-weight:1000;margin:0 0 8px" id="hProto"></div>
            <textarea id="proto" readonly></textarea>

            <div class="smallBtns">
              <button class="smallBtn" id="btnCopy"></button>
              <button class="smallBtn" id="btnClearPath"></button>
              <button class="smallBtn" id="btnPDF"></button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
/** ====== FALLBACK CONTENT (aby to nikdy nebolo prázdne) ====== */
const DEFAULT_CONTENT = {
  version: "0.1.5-fallback",
  trees: [
    {
      id: "01_01",
      title: { de: "01 12V komplett ausgefallen (Aufbau tot)", sk: "01 12V úplne vypadnuté (nadstavba mŕtva)" },
      subtitle: { de: "Kein Licht, keine Pumpe, Panel dunkel.", sk: "Nesvieti, nejde pumpa, panel tmavý." },
      tags: ["12v","aufbau","ebl","hauptschalter","sicherung","totalausfall","batterie"],
      start: "tree_01_01_start",
      nodes: {
        "tree_01_01_start": {
          type: "question",
          text: { de: "Ist der Hauptschalter für den Aufbau eingeschaltet?", sk: "Je hlavný vypínač nadstavby zapnutý?" },
          yes: "tree_01_01_hauptschalter_ok",
          no: "tree_01_01_hauptschalter_off"
        },
        "tree_01_01_hauptschalter_off": {
          type: "result",
          cause: { de: "Hauptschalter war AUS.", sk: "Hlavný vypínač bol VYPNUTÝ." },
          action: { de: "Schalter einschalten. Danach prüfen ob Licht, Pumpe oder Panel wieder funktionieren.", sk: "Zapni vypínač. Potom skontroluj či funguje svetlo, pumpa alebo panel." }
        },
        "tree_01_01_hauptschalter_ok": {
          type: "question",
          text: { de: "Sind Aufbaubatterien angeschlossen und liegt die Spannung über 12,0 V?", sk: "Sú palubné batérie pripojené a majú napätie nad 12,0 V?" },
          yes: "tree_01_01_battery_ok",
          no: "tree_01_01_battery_low"
        },
        "tree_01_01_battery_low": {
          type: "result",
          cause: { de: "Batterien leer / nicht korrekt angeschlossen.", sk: "Batérie sú vybité / nie sú správne pripojené." },
          action: { de: "Batterien laden oder korrekt anschließen. Hauptsicherung nahe Batterie prüfen.", sk: "Nabi alebo správne pripoj batérie. Skontroluj hlavnú poistku pri batérii." }
        },
        "tree_01_01_battery_ok": {
          type: "result",
          cause: { de: "Batteriespannung OK, Fehler liegt weiter im Aufbau-System.", sk: "Napätie batérie OK, chyba je ďalej v systéme nadstavby." },
          action: { de: "EBL prüfen: Batteriespannung am Eingang, Hauptsicherung, Masseverbindung.", sk: "Skontroluj EBL: napätie na vstupe, hlavnú poistku a kostru." }
        }
      }
    }
  ]
};

/** ====== I18N UI ====== */
const I18N = {
  de: {
    subtitle:"Wohnmobil Diagnose",
    faults:"Störungen",
    diag:"Diagnose",
    proto:"Protokoll",
    searchPH:"Suche (trittstufe, wasserpumpe, 12V...)",
    yes:"JA",
    no:"NEIN",
    back:"← SCHRITT ZURÜCK",
    copy:"Kopieren",
    clear:"Pfad löschen",
    pdf:"PDF Download",
    copied:"Kopiert",
    chooseFault:"Wähle links eine Störung.",
    adminPrompt:"ADMIN\n1 = Import content.json\n2 = Export content.json\n(Import überschreibt lokal)",
    importOk:"Import OK",
    importErr:"Import ERROR: JSON ungültig",
    loadErr:"FEHLER: content.json konnte nicht geladen werden"
  },
  sk: {
    subtitle:"Diagnostika obytných vozidiel",
    faults:"Poruchy",
    diag:"Diagnostika",
    proto:"Protokol",
    searchPH:"Hľadať (stupienok, pumpa, 12V...)",
    yes:"ÁNO",
    no:"NIE",
    back:"← SPÄŤ",
    copy:"Kopírovať",
    clear:"Vymazať cestu",
    pdf:"PDF Download",
    copied:"Skopírované",
    chooseFault:"Vyber vľavo poruchu.",
    adminPrompt:"ADMIN\n1 = Import content.json\n2 = Export content.json\n(Import prepíše lokálne)",
    importOk:"Import OK",
    importErr:"Import ERROR: neplatný JSON",
    loadErr:"CHYBA: content.json sa nepodarilo načítať"
  }
};

let LANG = localStorage.getItem("lang") || "de";
let TREES = [];
let CONTENT_VERSION = "n/a";

let currentTree = null;
let currentNodeId = null;
let path = []; // {q, a}

/** ====== HELPERS ====== */
const $ = (id)=>document.getElementById(id);
const T = (k)=> (I18N[LANG] && I18N[LANG][k]) ? I18N[LANG][k] : k;

function pick(obj){
  if(!obj) return "";
  if(typeof obj === "string") return obj;
  if(obj[LANG]) return obj[LANG];
  if(obj.de) return obj.de;
  if(obj.sk) return obj.sk;
  const keys = Object.keys(obj);
  return keys.length ? obj[keys[0]] : "";
}

function normalizeTrees(data){
  // podporíme: {version, trees:[...]} alebo priamo [...]
  if(Array.isArray(data)) return {version:"array", trees:data};
  if(data && Array.isArray(data.trees)) return {version: data.version || "obj", trees:data.trees};
  return {version:"invalid", trees:[]};
}

/** ====== LOAD CONTENT ====== */
async function loadContent(){
  // 1) local override (admin import)
  const ov = localStorage.getItem("content_override");
  if(ov){
    try{
      const parsed = JSON.parse(ov);
      const norm = normalizeTrees(parsed);
      if(norm.trees.length){
        CONTENT_VERSION = "override";
        TREES = norm.trees;
        return;
      }
    }catch(e){}
  }

  // 2) fetch content.json
  try{
    const r = await fetch("./content.json", { cache:"no-store" });
    if(!r.ok) throw new Error("HTTP " + r.status);
    const data = await r.json();
    const norm = normalizeTrees(data);
    if(!norm.trees.length) throw new Error("Invalid JSON structure");
    CONTENT_VERSION = norm.version || "content.json";
    TREES = norm.trees;
  }catch(err){
    // 3) fallback
    console.error("content load failed:", err);
    const norm = normalizeTrees(DEFAULT_CONTENT);
    CONTENT_VERSION = DEFAULT_CONTENT.version;
    TREES = norm.trees;

    // zobraz chybu do listu
    $("faultList").innerHTML =
      `<div class="item"><b>${T("loadErr")}</b><span>${String(err?.message || err)}</span></div>`;
  }
}

/** ====== RENDER LIST ====== */
function renderList(){
  const q = ($("search").value || "").trim().toLowerCase();

  const items = TREES
    .map(t=>{
      const title = pick(t.title);
      const sub = pick(t.subtitle);
      const idPrefix = (t.id || "").replaceAll("_"," ").trim();
      const hay = (idPrefix + " " + title + " " + sub + " " + (t.tags||[]).join(" ")).toLowerCase();
      return {t, title, sub, idPrefix, hay};
    })
    .filter(x => !q || x.hay.includes(q));

  if(!items.length){
    $("faultList").innerHTML = `<div class="item"><b>—</b><span>${q ? "No match" : "No trees loaded"}</span></div>`;
    return;
  }

  $("faultList").innerHTML = items.map(x=>{
    // „01 01 …“ zobrazujem vždy ako prefix + title
    const label = (x.idPrefix ? (x.idPrefix + " ") : "") + x.title;
    return `<div class="item" data-id="${x.t.id}">
      <b>${escapeHtml(label)}</b>
      <span>${escapeHtml(x.sub || "")}</span>
    </div>`;
  }).join("");

  [...$("faultList").querySelectorAll(".item[data-id]")].forEach(el=>{
    el.onclick = ()=>selectTree(el.getAttribute("data-id"));
  });
}

function escapeHtml(s){
  return String(s).replace(/[&<>"']/g, m=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/** ====== SELECT TREE / NODE ====== */
function selectTree(treeId){
  currentTree = TREES.find(t=>t.id===treeId) || null;
  path = [];
  currentNodeId = currentTree ? (currentTree.start || currentTree.root || null) : null;
  renderNode();
  renderProtocol();
}

function getNode(id){
  if(!currentTree || !currentTree.nodes) return null;
  return currentTree.nodes[id] || null;
}

function renderNode(){
  $("resTitle").textContent = "";
  $("resText").textContent = "";

  if(!currentTree){
    $("qText").textContent = T("chooseFault");
    $("btnYes").style.display = "none";
    $("btnNo").style.display = "none";
    $("btnBack").style.display = "none";
    return;
  }

  const node = getNode(currentNodeId);
  if(!node){
    $("qText").textContent = "Node not found: " + String(currentNodeId);
    $("btnYes").style.display = "none";
    $("btnNo").style.display = "none";
    $("btnBack").style.display = "inline-block";
    return;
  }

  $("btnYes").style.display = "inline-block";
  $("btnNo").style.display = "inline-block";
  $("btnBack").style.display = "inline-block";

  if(node.type === "question"){
    $("qText").textContent = pick(node.text);
  }else if(node.type === "result"){
    $("qText").textContent = "";
    $("resTitle").textContent = (LANG==="de") ? "Ergebnis:" : "Výsledok:";
    const c = pick(node.cause);
    const a = pick(node.action);
    $("resText").textContent = (c ? (c + "\n") : "") + (a ? a : "");
  }else{
    $("qText").textContent = "Unsupported node type";
  }
}

function answer(isYes){
  if(!currentTree) return;
  const node = getNode(currentNodeId);
  if(!node || node.type !== "question") return;

  const ansLabel = isYes ? T("yes") : T("no");
  path.push({ q: pick(node.text), a: ansLabel });

  currentNodeId = isYes ? node.yes : node.no;
  renderNode();
  renderProtocol();
}

function back(){
  if(!currentTree) return;
  if(!path.length){
    currentNodeId = currentTree.start || currentTree.root || null;
    renderNode(); renderProtocol();
    return;
  }
  // jednoducho: reset a replay path-1
  const replay = path.slice(0, -1);
  currentNodeId = currentTree.start || currentTree.root || null;
  path = [];
  for(const step of replay){
    const node = getNode(currentNodeId);
    if(!node || node.type!=="question") break;
    const yes = (step.a === T("yes"));
    path.push(step);
    currentNodeId = yes ? node.yes : node.no;
  }
  renderNode(); renderProtocol();
}

/** ====== PROTOCOL ====== */
function renderProtocol(){
  if(!currentTree){
    $("proto").value = "";
    return;
  }
  const now = new Date();
  const title = pick(currentTree.title);
  const idPrefix = (currentTree.id || "").replaceAll("_"," ").trim();
  const faultLine = (idPrefix ? (idPrefix + " ") : "") + title;

  const steps = path.map((p,i)=> `${i+1}. ${p.q} [${p.a}]`).join("\n");

  // ak je výsledok
  let resultTxt = "";
  const node = getNode(currentNodeId);
  if(node && node.type==="result"){
    const c = pick(node.cause);
    const a = pick(node.action);
    resultTxt = "\n\n" + ((LANG==="de") ? "Ergebnis:\n" : "Výsledok:\n") + (c ? c + "\n" : "") + (a ? a : "");
  }

  const proto =
`${(LANG==="de")?"Zeit":"Čas"}: ${now.toLocaleString()}
${(LANG==="de")?"Sprache":"Jazyk"}: ${LANG.toUpperCase()}
${(LANG==="de")?"Störung":"Porucha"}: ${faultLine}

${(LANG==="de")?"Schritte":"Kroky"}:
${steps || "-"}` + resultTxt;

  $("proto").value = proto;
}

/** ====== PDF (print window) ====== */
function downloadPDF(){
  const txt = $("proto").value || "";
  const w = window.open("", "_blank");
  if(!w) return;
  w.document.open();
  w.document.write(`<pre style="font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:14px; white-space:pre-wrap;">${escapeHtml(txt)}</pre>`);
  w.document.close();
  w.focus();
  setTimeout(()=>w.print(), 250);
}

/** ====== ADMIN ====== */
function admin(){
  const choice = prompt(T("adminPrompt"));
  if(!choice) return;

  if(choice.trim()==="1"){
    const inp = document.createElement("input");
    inp.type="file";
    inp.accept="application/json,.json";
    inp.onchange = async ()=>{
      const f = inp.files && inp.files[0];
      if(!f) return;
      const txt = await f.text();
      try{
        const parsed = JSON.parse(txt);
        // uložíme presne to, čo importuješ (array aj object)
        localStorage.setItem("content_override", JSON.stringify(parsed));
        alert(T("importOk"));
        hardReset(true);
      }catch(e){
        alert(T("importErr"));
      }
    };
    inp.click();
  }

  if(choice.trim()==="2"){
    const payload = JSON.stringify({ version: CONTENT_VERSION, trees: TREES }, null, 2);
    const blob = new Blob([payload], {type:"application/json;charset=utf-8"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "content_export.json";
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 1500);
  }
}

/** ====== RESET ====== */
function hardReset(reload=false){
  currentTree = null;
  currentNodeId = null;
  path = [];
  $("search").value = "";
  $("proto").value = "";
  $("resTitle").textContent = "";
  $("resText").textContent = "";
  $("qText").textContent = T("chooseFault");
  if(reload){
    init(); // znovu načíta
  }else{
    renderList();
    renderNode();
    renderProtocol();
  }
}

/** ====== APPLY LANGUAGE ====== */
function applyLangUI(){
  document.documentElement.lang = LANG;
  $("subtitleLine").textContent = T("subtitle");
  $("hFaults").textContent = T("faults");
  $("hDiag").textContent = T("diag");
  $("hProto").textContent = T("proto");
  $("search").placeholder = T("searchPH");
  $("btnYes").textContent = T("yes");
  $("btnNo").textContent = T("no");
  $("btnBack").textContent = T("back");
  $("btnCopy").textContent = T("copy");
  $("btnClearPath").textContent = T("clear");
  $("btnPDF").textContent = T("pdf");
  if(!currentTree) $("qText").textContent = T("chooseFault");
  $("ver").textContent = "v" + String(CONTENT_VERSION || "n/a");
}

/** ====== INIT ====== */
async function init(){
  applyLangUI();
  await loadContent();
  applyLangUI();
  renderList();
  renderNode();
  renderProtocol();
}

$("btnDE").onclick = ()=>{ LANG="de"; localStorage.setItem("lang",LANG); applyLangUI(); renderList(); renderNode(); renderProtocol(); };
$("btnSK").onclick = ()=>{ LANG="sk"; localStorage.setItem("lang",LANG); applyLangUI(); renderList(); renderNode(); renderProtocol(); };
$("btnAdmin").onclick = ()=>admin();
$("btnReset").onclick = ()=>{
  // reset = zmaže override + stav
  localStorage.removeItem("content_override");
  hardReset(true);
};

$("search").oninput = ()=>renderList();

$("btnYes").onclick = ()=>answer(true);
$("btnNo").onclick = ()=>answer(false);
$("btnBack").onclick = ()=>back();

$("btnCopy").onclick = async ()=>{
  try{
    await navigator.clipboard.writeText($("proto").value || "");
    // malý vizuál netreba, stačí ticho
  }catch(e){}
};

$("btnClearPath").onclick = ()=>{
  path = [];
  if(currentTree) currentNodeId = currentTree.start || currentTree.root || null;
  renderNode(); renderProtocol();
};

$("btnPDF").onclick = ()=>downloadPDF();

init();
</script>
</body>
</html>
